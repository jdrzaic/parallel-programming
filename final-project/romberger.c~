#include<stdio.h>
#include<stdlib.h>
#include<mpi.h>
#include<math.h>

#define first_ind(a,b,rang,size,h) (ceil((b + ((double)rank / size) * (b - a)) / h))

double func(double value) {
	return value;
}

double func2(double value) {
	return value * value;
}

int first_one(int n) {
	int pos = 0;
	if(n == 0) return 0;
	while((n >> pos) % 2 == 0) pos++;
	return pos;
}

int main(int argc, char** argv) {
	int size;
	int rank;

	double a, b, h;
	int p;

	MPI_Init(&argc, &argv);
	MPI_Comm_rank(MPI_COMM_WORLD, &rank);
	MPI_Comm_size(MPI_COMM_WORLD, &size);

	a = atof(argv[1]);
	b = atof(argv[2]);
	p = atoi(argv[3]);
	int twotop = (int)pow(2, p);
	h = (b - a) / twotop;
	//index of first point for this process
	int first = first_ind(a, b, rang, size, h);
	int last = first_ind(a, b, rang + 1, size, h);
	double* trap = (double*)calloc(p, sizeof(double));
	double* recv = (double*)malloc(p * sizeof(double));
	for(int i = first; i < last; ++i) {
		double point = i * h;
		double f_value = func(point);
		int to = first_one(i);
		if(i == 0) {
			to = p - 1;
			f_value /= 2;
		}
		if(i == twotop) f_value /= 2;
		for(int j = 0; j <= to; ++j) {
			trap[j] += f_value;
		}
	}

	MPI_Reduce(trap, recv, p, MPI_DOUBLE, MPI_SUM, 0, MPI_COMM_WORLD);
	
	MPI_Finalize();
	return 0;
}

